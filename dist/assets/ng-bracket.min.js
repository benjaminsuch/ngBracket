!function(){angular.module("templates",[]).run(["$templateCache",function(t){t.put("app/partials/bracket.tpl.html",'<!-- Bracket control -->\r\n<div ng-cloak id="ngBracket" ng-style="layoutProperties.bracket">\r\n\t<!-- Double conference layout -->\r\n\t<div ng-if="bracketData.tournament.doubleConference">\r\n\t\t<div class="left" ng-repeat="c in bracketData.tournament.conferences" ng-init="reversed=($index===2)">\r\n\t\t\t<div class="conferenceHeader" ng-class="{alignLeft:$index === 0, alignCenter:$index === 1, alignRight:$index == 2}">{{c.conferenceName}}</div>\r\n\t\t\t<div class="roundWrap">\r\n\t\t\t\t<div ng-repeat="m in c.matches" class="round left" id="round-{{$index+1}}" ng-class="{\'doubleFinal\': bracketData.tournament.type === \'DE\' && (($parent.$first && $last && (prop.finals2C1 === true || prop.finals2C1 === undefined)) || ($parent.$last && $last && (prop.finals2C2 === true || prop.finals2C2 === undefined)))}" on-begin-render>\r\n\t\t\t\t\t<div class="roundHeader" ng-if="$parent.$index !== 1">\r\n\t\t\t\t\t\t<span class="centered">{{ \'Round \' + ($index+1) }}</span>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class="matchWrapper" ng-repeat="match in m" id="{{ match.meta.matchId }}">\r\n\t\t\t\t\t\t<match></match>\r\n\t\t\t\t\t\t<connectors></connectors>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<!-- Single conference layout -->\r\n\t<div ng-if="!bracketData.tournament.doubleConference">\r\n\t\t<div ng-repeat="m in bracketData.tournament.conferences[0].matches" class="round left" id="round-{{$index+1}}">\r\n\t\t\t<div class="roundHeader">\r\n\t\t\t\t<span ng-if="bracketData.tournament.type === \'SE\'" class="centered">{{ ($index+1 == bracketData.tournament.matches.length) | iif : \'Finals\' : (\'Round \' + ($index+1)) }}</span>\r\n\t\t\t\t<span ng-if="bracketData.tournament.type === \'DE\' && $index+1 >= layoutProperties.startingRound" ng-init="rn=(!layoutProperties.startingRound || layoutProperties.startingRound == 1) ? $index + 1 : $index + 2 - layoutProperties.startingRound" class="centered">{{ ($index+1 == bracketData.tournament.matches.length) | iif : \'Finals\' : (\'Round \' + rn) }}</span>\r\n\t\t\t</div>\r\n\t\t\t<div class="matchWrapper" ng-repeat="match in m" id="{{ match.meta.matchId }}">\r\n\t\t\t\t<match></match>\r\n\t\t\t\t<connectors></connectors>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>'),t.put("app/partials/match.tpl.html",'<div class="match" ng-init="results={winner:\'\', loser:\'\'}"\r\n     ng-class="{tbd:((!team1Details.id || 0 === team1Details.id.length) && (!team2Details.id || 0 === team2Details.id.length)), hidden:(match.meta.matchType === \'finals2\' && ((conference === 1 && prop.finals2C1 === false) || (conference === 2 && prop.finals2C2 === false)))}"\r\n     ng-click="showDetails($event)">\r\n\t<team team="match.team1" teamdetails="team1Details" description="team1Description"></team>\r\n\t<div ng-class="{separator: (match.team1.id.length > 0 && match.team2.id.length > 0)}"></div>\r\n\t<team team="match.team2" teamdetails="team2Details" description="team2Description"></team>\r\n</div>'),t.put("app/partials/score.tpl.html",'<div class="score" ng-click="editScore()" ng-init="status=\'uneditable\'" ng-switch="status">\r\n\t<input class="score" ng-switch-when="editable" ng-blur="endEditScore()" do-focus="" type="number" ng-model="team.score" ng-pattern="/^[0-9]+$/">\r\n\t<span ng-class="{score:true, empty: (!team.id || 0 === team.id.length)}" ng-switch-when="uneditable">{{ team.score }}</span>\r\n</div>'),t.put("app/partials/team.tpl.html",'<div class="team" ng-mouseenter="highlightTrack(team.id)" ng-mouseleave="highlightTrack()"\r\n     ng-class="{empty: (!team.id || 0 === team.id.length), highlight: (highlight.teamId === team.id), loser: (results.loser.length > 0 && results.loser == team.id), winner: (results.winner.length > 0 && results.winner == team.id), gold: (highlight.goldId === team.id), silver: (highlight.silverId === team.id), bronze: (highlight.bronzeId === team.id), finals: ((match.meta.matchType === \'finals\' && !prop.finals2C1) || (match.meta.matchType === \'finals2\' && prop.finals2C1) || match.meta.matchType === \'bronze\')}" ng-init="status=\'uneditable\'" ng-switch="status">\r\n\t<div class="flag"></div>\r\n\t<span class="teamname" ng-switch-default team-context-menu ng-dblclick="editTeam()">{{ (description.length > 0 && !teamdetails.name) | iif : description : ((teamdetails.name.length === 0) | iif : \'(No name)\' : teamdetails.name) }}</span>\r\n\t<input class="teamInput" ng-switch-when="editable" ng-blur="endEditTeam()" do-focus="" type="text" ng-model="teamdetails.name">\r\n\t<score team="team" match="match" results="results"></score>\r\n</div>')}])}(),function(){function t(t,e,a){function n(a,n){e.bracketData.teams=n,e.bracketData.tournament=a,e.bracketData.reload(),t.info("bracketData",e.bracketData)}e.bracketData={teams:[],tournament:{type:"SE",matches:[]},options:{onTeamRightClick:angular.noop,onTeamClick:angular.noop,onMatchClick:angular.noop,onMatchRightClick:angular.noop}},e.tType="SE",e.playersToGenerate=5,e.playersToGenerate2="",e.generateWithRandomPlayers=function(){function t(t,e){var a=[];e=e?e:0;for(var n=1;n<=t;n++)a.push({name:"Team "+(n+e),id:(n+e).toString()});return a}if(e.playersToGenerate){e.bracketData.teams=[];var r=parseInt(e.playersToGenerate),c=parseInt(e.playersToGenerate2);if(r>3&&(!c||c>3)){e.bracketData.teams=[],e.bracketData.teams.push(t(r));var i;c>3?(e.bracketData.teams.push(t(c,r)),i=a.newTournament(e.tType,e.bracketData.teams,e.playBronzeMatch,!0),i.conferences[0].conferenceName="West",i.conferences[2].conferenceName="East"):i=a.newTournament(e.tType,e.bracketData.teams[0],e.playBronzeMatch,!1),n(i,e.bracketData.teams)}}}}angular.module("ngBracket",["templates"]).controller("BracketController",t),t.$inject=["$log","$scope","tournamentGenerator"]}();var app=angular.module("ngBracket");app.directive("ngBracket",["data","layoutService",function(t,e){return{restrict:"E",templateUrl:"app/partials/bracket.tpl.html",replace:!1,scope:{bracketData:"="},controller:["$scope",function(a){a.bracketData&&(a.bracketData.reload=function(){t.loadTournament(a.bracketData),a.layoutProperties||(a.layoutProperties=e.getProperties()),e.refresh()})}]}}]).directive("doFocus",function(){return{restrict:"A",link:function(t,e,a){e&&(e[0].focus(),e[0].select())}}}).directive("teamContextMenu",["data",function(t){return{restrict:"A",scope:!1,link:function(e,a,n){function r(t){c.onTeamRightClick(t,e.team)}var c=t.getOptions();c.onTeamRightClick&&a.bind("contextmenu",r),e.$on("$destroy",function(){a.unbind("contextmenu",r)})}}}]).directive("onBeginRender",["data","connectorService","layoutService",function(t,e,a){return function(n,r,c){if(t.isDoubleConference()){var i,m=a.getProperties(),l=m.matchWidth+m.matchMarginH;if(n.$parent.$last&&n.$last){var h=r.parent()[0];for(i=h.childNodes.length;i--;)h.appendChild(h.childNodes[i])}if("DE"===t.getTournamentType())if(n.$last&&n.$parent.$first)n.prop=t.getProperties();else if(n.$last&&n.$parent.$last){n.prop=t.getProperties();var o=null,s=null,d=n.$watch("prop.finals2C2",function(t,a){if(null===o&&(o=angular.element(e.findConferenceFinals().C2_1.parentElement)),null===s)for(i=0;i<o[0].parentElement.children.length;i++)if(o[0].parentElement.children[i].classList.contains("connectors")){s=o[0].parentElement.children[i];break}if(t&&a===!1)for(o.css("left",o.prop("offsetLeft")+l+"px"),i=0;i<s.children.length;i++)angular.element(s.children[i]).css("left",s.children[i].offsetLeft+l+"px");else if(t===!1)for(o.css("left",o.prop("offsetLeft")-l+"px"),i=0;i<s.children.length;i++)angular.element(s.children[i]).css("left",s.children[i].offsetLeft-l+"px")},!0);n.$on("$destroy",function(){d()})}}}}]).directive("match",["connectorService","layoutService","data","$filter","highlight",function(t,e,a,n,r){return{restrict:"E",scope:!1,templateUrl:"app/partials/match.tpl.html",replace:!0,link:{pre:function(c,i,m){c.getTeamDetails=function(t,e){function r(t,e){return n("getById")(t,e)}var c=r(a.getTeams(e?e:1),t);return!e&&null===c&&a.isDoubleConference()&&(c=r(a.getTeams(2),t)),c};var l,h=c.match.meta.matchId.split("-");"C1"===h[1]&&(l=1),"C2"===h[1]&&(l=2),c.highlight=r.mapHighlight(),c.team1Details=c.getTeamDetails(c.match.team1.id,l),c.team2Details=c.getTeamDetails(c.match.team2.id,l);var o=c.$watch("match.team1",function(t,e){t&&(c.team1Details=c.getTeamDetails(c.match.team1.id,l))},!0),s=c.$watch("match.team2",function(t,e){t&&(c.team2Details=c.getTeamDetails(c.match.team2.id,l))},!0),d=parseInt(h[2]),u=parseInt(h[3]),p=e.getProperties(),g="C1"===h[1]?p.startingRound1:"C2"===h[1]?p.startingRound2:null;c.match.meta.team1Parent&&(c.team1Description="Loser of Round "+(parseInt(c.match.meta.team1Parent.split("-")[2])-g+1)+" match "+c.match.meta.team1Parent.split("-")[3]),c.match.meta.team2Parent&&(c.team2Description="Loser of Round "+(parseInt(c.match.meta.team2Parent.split("-")[2])-g+1)+" match "+c.match.meta.team2Parent.split("-")[3]),"finals2"===c.match.meta.matchType&&0===c.match.team1.id.length&&0===c.match.team2.id.length&&(c.team1Description="Finals round 2 if necessary",c.prop=a.getProperties(),"C1"===h[1]?c.conference=1:"C2"===h[1]&&(c.conference=2)),i.prop("id",c.match.meta.matchId),i.css("left",p.matchMarginH/2+"px"),"finals"==c.match.meta.matchType&&(c.finals=!0,a.isDoubleConference()&&2===l&&"DE"==a.getTournamentType()&&i.css("left",1.5*p.matchMarginH+p.matchWidth+"px"));var f="finals2"===c.match.meta.matchType&&"DE"===a.getTournamentType();f&&1===l&&i.css("left",1.5*p.matchMarginH+p.matchWidth+"px");var y=0,v="finals"===c.match.meta.matchType&&"DE"===a.getTournamentType(),T="L"===c.match.meta.matchId.slice(-1)||v?"-L":"";if(1===d||0===T.length&&d===g){var b=c.match.meta.UIShiftDown?c.match.meta.UIShiftDown:0;b+="C1"===h[1]&&p.paddingTopC1?p.paddingTopC1:"C2"===h[1]&&p.paddingTopC2?p.paddingTopC2:0,y=(p.matchHeight+p.matchMarginV)*(u-1+b)+p.roundMarginTop}else if(2===c.match.meta.matchType){var I="C1"===h[1]?p.paddingTopC1:"C2"===h[1]?p.paddingTopC2:0;y=(p.matchHeight+p.matchMarginV)*(u-1+I)+p.roundMarginTop;var C="C1"===h[1]?p.lbOffset1:"C2"===h[1]?p.lbOffset2:0;T.length>0&&C>0&&y<C&&(y+=C-p.roundMarginTop)}else if("bronze"===c.match.meta.matchType||f){var k=angular.element(document.getElementById("match-"+h[1]+"-"+h[2]+"-1"));y=k.prop("offsetTop"),"bronze"===c.match.meta.matchType&&(y+=p.matchHeight+40,c.bronzeMatch=!0)}else{var M=t.findConnectingMatch(c.match);if(y=angular.element(M[0].firstElementChild).prop("offsetTop"),"F"!==h[1]&&1!=c.match.meta.matchType)if(a.isDoubleConference()&&v&&"C2"===h[1]){var D=t.findConferenceFinals();y=D.C1.offsetTop}else{var E=M.scope().match.meta.matchId.split("-"),$=parseInt(E[3]),j="match-"+E[1]+"-"+(d-1)+"-"+(v?"1-L":$+1+T),P=angular.element(document.getElementById(j)),S=angular.element(P[0].firstElementChild).prop("offsetTop")+p.matchHeight;v?y+=(S-y)/4:y=y+(S-y)/2-p.matchHeight/2}"F"===h[1]&&"1"===h[3]&&(y-=p.matchHeight)}i.css("top",y+"px"),c.$on("$destroy",function(){o(),s()})},post:function(e,n,r){function c(){return{matchId:e.match.meta.matchId,team1:e.team1Details,team2:e.team2Details,results:e.match}}function i(t){l.onMatchClick(t,c())}function m(t){l.onMatchRightClick(t,c())}var l=a.getOptions();l.onMatchRightClick&&n.bind("contextmenu",m),l.onMatchClick&&n.bind("click",i),"conference-finals"===e.match.meta.matchType&&"C2"===e.match.meta.matchId.split("-")[1]&&t.findConferenceFinals(),e.$on("$destroy",function(){n.unbind("contextmenu",m),n.unbind("click",i)})}}}}]).directive("score",["data",function(t){return{restrict:"E",scope:{team:"=",match:"=",results:"="},templateUrl:"app/partials/score.tpl.html",link:function(e,a,n){e.editScore=function(t){e.match.team1.id&&e.match.team2.id&&(e.status="editable")},e.calculateResults=function(a){if("undefined"==typeof e.match.team1.score||""===e.match.team1.score||"undefined"==typeof e.match.team2.score||""===e.match.team2.score||e.match.team1.score===e.match.team2.score)return e.results.winner="",void(e.results.loser="");var n=t.getOptions();if(!n.onScoreChanged||n.onScoreChanged(e.match)){var r;e.match.team1.score>e.match.team2.score?(r=e.match.team1.id,e.results.loser=e.match.team2.id):(r=e.match.team2.id,e.results.loser=e.match.team1.id),e.results.winner=r;var c="DE"===t.getTournamentType()&&"L"!==e.match.meta.matchId.slice(-1);t.updateTournament(e.match,r,e.results.loser,a,c)}},e.endEditScore=function(){e.status="uneditable",e.calculateResults(null)};var r=e.$watch("match.team1.id",function(t,a){t&&e.calculateResults(a)},!0),c=e.$watch("match.team2.id",function(t,a){t&&e.calculateResults(a)},!0);e.$on("$destroy",function(){r(),c()})},replace:!0}}]).directive("connectors",["connectorService","layoutService","$compile","data",function(t,e,a,n){return{restrict:"E",template:'<div class="connectors"></div>',replace:!0,scope:!1,link:function(r,c,i){function m(t,e,n,c,i,m,l){var h=null===i?"cMatch1":"cMatch"+i.toString(),s=null===i?m?"tbdB:match.team1.id.length === 0 && match.team2.id.length === 0":"":1==i?"tbdB:match.team1.id.length === 0":"tbdB:match.team2.id.length === 0",d=l?h+".team1.score > "+h+".team2.score && ":"",u=l?h+".team2.score > "+h+".team1.score && ":"",p="highlight: highlight.teamId !== null && ((match.team1.id === highlight.teamId || match.team2.id === highlight.teamId) && (("+d+h+".team1.id === highlight.teamId) || ("+u+h+".team2.id === highlight.teamId)))",g=",gold: highlight.goldId !== null && ((highlight.goldId === match.team1.id || match.team2.id === highlight.goldId) && (("+h+".team1.id === highlight.goldId) || ("+h+".team2.id === highlight.goldId)))",f="finals2"===r.match.meta.matchType?",hidden:(prop.finals2"+o[1]+" === false)":"",y='ng-class="{'+s+(s.length>0?", ":"")+p+f+g+'}"';return angular.element(a('<div class="connector" style="left:'+n+"px;top:"+c+"px;width:"+t+"px;height:"+e+'px" '+y+"></div>")(r))}function l(e,a,i,l){if(a>1&&(i||!i&&(a>e.startingRound1&&"C1"===o[1]||a>e.startingRound2&&"C2"===o[1]))){var h=t.findChildMatch(c.parent()),s=angular.element(t.findConnectingMatch(r.match)[0].firstElementChild);r.cMatch1=s.scope().match;var d,u=h.prop("offsetLeft")+e.borderThickness+(l?e.matchWidth:0),p=h.prop("offsetTop")+e.matchHeight/2;if(1===r.match.meta.matchType||"finals2"===r.match.meta.matchType){var g="L"===r.match.meta.matchId.slice(-1)||"finals2"===r.match.meta.matchType;return d=l?u:u-e.matchMarginH,void c.append(m(e.matchMarginH-e.borderThickness,1,d,p,null,g).addClass("connectorBottom"))}var f="DE"===n.getTournamentType()&&"finals"===r.match.meta.matchType,y=e.matchMarginH/2-e.borderThickness,v=p-s.prop("offsetTop")-e.matchHeight/2;d=l?u:u-y-e.borderThickness;var T=p-v,b=l?"connectorBottom connectorRight":"connectorBottom connectorLeft",I=m(y,v,d,T,1,null,f).addClass(b);c.append(I),d=l?d+y+e.borderThickness:d-y,c.append(m(y,1,d,T,1,null,f).addClass("connectorTop"));var C=s.scope().match.meta.matchId.split("-"),k="finals"===r.match.meta.matchType&&"DE"===n.getTournamentType(),M="L"==C.slice(-1)||k?"-L":"",D=C[0]+"-"+C[1]+"-"+C[2]+"-"+(k?1:parseInt(C[3])+1)+M,E=angular.element(t.findChildMatch(document.getElementById(D)));r.cMatch2=E.scope().match,v=E.prop("offsetTop")+e.matchHeight/2-p,d=l?u:u-y-e.borderThickness,T=p,b=l?"connectorTop connectorRight":"connectorTop connectorLeft",c.append(m(y,v,d,T,2).addClass(b)),d=l?d+y+e.borderThickness:d-y,T=p+v,c.append(m(y,1,d,T,2).addClass("connectorTop"))}}if(2!=r.match.meta.matchType&&"bronze"!=r.match.meta.matchType){var h=e.getProperties(),o=r.match.meta.matchId.split("-"),s=parseInt(o[2]),d="L"===r.match.meta.matchId.slice(-1);if("F"==o[1]){r.confFinals=t.findConferenceFinals();var u=t.findChildMatch(c.parent()),p=u.prop("offsetTop")+h.matchHeight/2,g=u.prop("offsetLeft"),f=h.matchMarginH/2,y=r.confFinals.C1.offsetTop-p+h.matchHeight/2;c.append(m(f,y,g-f,p,1).addClass("connectorTop connectorLeft"));c.append(m(f,1,g-h.matchMarginH+h.borderThickness,p+y,1).addClass("connectorBottom")),r.cMatch1=angular.element(r.confFinals.C1).scope().match,g+=h.matchWidth+h.borderThickness,c.append(m(f,y,g,p,2).addClass("connectorTop connectorRight")),c.append(m(f,1,g+f,p+y,2).addClass("connectorBottom"));var v=r.$watch("confFinals.C2",function(t,e){t&&(r.cMatch2=angular.element(r.confFinals.C2).scope().match,v())})}else l(h,s,d,"C2"==o[1])}}}}]).directive("team",["data","highlight",function(t,e){return{restrict:"E",templateUrl:"app/partials/team.tpl.html",replace:!0,scope:{team:"=",teamdetails:"=",description:"="},link:function(a,n,r){function c(t){i.onTeamClick(t,a.team)}a.highlight=a.$parent.highlight,a.results=a.$parent.results,a.match=a.$parent.match,a.highlightTrack=function(t){e.setHighlight(t)},a.editTeam=function(){"Not started"===t.getProperties().status&&a.team.id&&(a.status="editable")},a.endEditTeam=function(){a.status="uneditable"};var i=t.getOptions();"finals"!==a.match.meta.matchType&&"finals2"!==a.match.meta.matchType||"DE"!==t.getTournamentType()||(a.prop=t.getProperties()),i.onTeamClick&&n.bind("click",c),a.$on("$destroy",function(){n.unbind("click",c)})}}}]);var app=angular.module("ngBracket");app.findParentByAttribute=function(t,e,a){if(null===t||null===e||null===a)return null;for(var n=null,r=angular.element(t);null!==r.parent()&&r.parent().length>0;)if(r=r.parent(),r.attr(e)===a){n=r;break}return n},app.filter("iif",function(){return function(t,e,a){return t?e:a}}),app.filter("getById",function(){return function(t,e){for(var a=0;a<t.length;a++)if(t[a].id==e)return t[a];return null}}),app.filter("reverse",function(){return function(t,e){return 2===e?t.slice().reverse():t}}),app.findFirstRound=function(t){for(var e=0;e<t.length;e++)if("L"!==t[e][0].meta.matchId.slice(-1))return e;return null},app.factory("highlight",function(){var t={teamId:null,goldId:null,silverId:null,bronzeId:null};return{mapHighlight:function(){return t},setHighlight:function(e){t.teamId=e&&e.length>0?e:null},getProperties:function(){return t}}}).factory("data",["highlight",function(t){var e=null;return{getTeams:function(t){var a=t?t-1:null;return t?e.teams[a]:1===e.teams.length?e.teams[0]:e.teams},getMatches:function(t){return"C1"===t?e.tournament.conferences[0].matches:"C2"===t?e.tournament.conferences[2].matches:"F"===t?e.tournament.conferences[1].matches:e.tournament.conferences},getTournamentType:function(){return e.tournament.type},isDoubleConference:function(){return e.tournament.doubleConference},getProperties:function(){return e.tournament.properties},getOptions:function(){return e.options},updateTournament:function(a,n,r,c,i){function m(t,e,a,n){null!==t&&(a.indexOf(t.team1.id)!==-1?t.team1.id=e:a.indexOf(t.team2.id)!==-1?t.team2.id=e:!(n||E>y)||t.team1.id&&0!==t.team1.id.length?t.team2.id=e:t.team1.id=e)}function l(t,e){for(var a=0;a<g[e].length;a++)if(g[e][a].meta.matchType==t)return g[e][a];return null}function h(t,e){void 0!==e?(e.indexOf(t.team1.id)>-1&&(k.team1.id="",k.team1.score=""),e.indexOf(t.team2.id)>-1&&(k.team2.id="",k.team2.score="")):(k.team1.id="",k.team2.id="",k.team1.score="",k.team2.score="")}"Not started"===e.tournament.properties.status&&(e.tournament.properties.status="In progress");var o,s,d,u,p=a.meta.matchId.split("-"),g="C2"==p[1]?e.tournament.conferences[2].matches:e.tournament.conferences[0].matches,f=parseInt(p[2]),y=parseInt(p[3]),v="L"===p[p.length-1],T=f===g.length-1,b=[a.team1.id,a.team2.id],I=t.getProperties();if("F"===p[1])return void("bronze"===a.meta.matchType?I.bronzeId=n:(I.goldId=n,I.silverId=r));if(e.tournament.doubleConference||"SE"!==e.tournament.type){if(!e.tournament.doubleConference&&"DE"===e.tournament.type&&"bronze"===a.meta.matchType)return void(I.bronzeId=n)}else{if("finals"===a.meta.matchType)return I.goldId=n,void(I.silverId=r);if("bronze"===a.meta.matchType)return void(I.bronzeId=n)}if(null!==c&&c.length>0&&b.push(c),"DE"===e.tournament.type&&"finals"===a.meta.matchType){var C=g.length-2;d=g[C].length-1,s=g[C][d].team1.score>g[C][d].team2.score?g[C][d].team1.id:g[C][d].team2.id,"C1"===p[1]?e.tournament.properties.finals2C1=u=r!=s:"C2"===p[1]&&(e.tournament.properties.finals2C2=u=r!=s);var k=l("finals2",g.length-1);if(r!=s?(null!==k&&(k.team1.id=a.team1.id,k.team2.id=a.team2.id),e.tournament.doubleConference&&(k=e.tournament.conferences[1].matches[0][0],h(k,b),e.tournament.conferences[1].matches[0].length>1&&(k=e.tournament.conferences[1].matches[0][1],h(k,b)),I.goldId=null,I.silverId=null,I.bronzeId=null)):null!==k&&(h(k),I.goldId=n,I.silverId=r),u)return I.goldId=null,void(I.silverId=null)}if("SE"===e.tournament.type&&f===g.length||"DE"===e.tournament.type&&("bronze"===a.meta.matchType||"finals2"===a.meta.matchType||u===!1)){if(e.tournament.doubleConference&&f===g.length){var M=e.tournament.conferences[1].matches[0];m(M[0],n,b,"C1"===p[1]),M.length>1&&m(M[1],r,b,"C1"===p[1])}return void(e.tournament.doubleConference||"finals2"!==a.meta.matchType||(I.goldId=n,I.silverId=r))}if("SE"===e.tournament.type&&T&&g[g.length-1].length>1||"DE"===e.tournament.type&&v&&(T||f===g.length-2)||e.tournament.doubleConference&&"DE"===e.tournament.type){d=g[g.length-1].length;var D=l("bronze",g.length-1);m(D,r,b,1===y)}var E=0,$=g[f],j=v&&T;for(o=0;o<$.length;o++)if(2!=$[o].meta.matchType){if(v&&"L"!==$[o].meta.matchId.slice(-1)&&!T)continue;if(E+=1==$[o].meta.matchType?1:2,E>=y){m($[o],n,b,j);break}}if(i){var P=parseInt(a.meta.loserMatchId.split("-")[2])-1,S=g[P];for(o=S.length-1;o>=0;o--){if(S[o].meta.team1Parent===a.meta.matchId){S[o].team1.id=r;break}if(S[o].meta.team2Parent===a.meta.matchId){S[o].team2.id=r;break}}}},loadTournament:function(t){e=t}}}]).factory("connectorService",["data",function(t){var e={C1:null,C2:null,C2_1:null};return{findConnectingMatchId:function(e){var a,n,r=e.meta.matchId.split("-"),c=parseInt(r[2]),i=parseInt(r[3]),m="L"===e.meta.matchId.slice(-1)?"-L":"",l=0,h="F"===r[1]&&"finals"===e.meta.matchType?t.getMatches("C1"):t.getMatches(r[1]),o=0,s=t.getTournamentType();if(m.length>0)for(a=0;a<h[c-1].length;a++)if("L"===h[c-1][a].meta.matchId.slice(-1)){o=a;break}if("finals2"===e.meta.matchType)n="match-"+r[1]+"-"+c+"-1";else if("F"===r[1]){var d=h[h.length-1];n="DE"===s?d[1].meta.matchId:d[0].meta.matchId}else{for(a=0;a<i;a++)2!=h[c-1][a+o].meta.matchType&&(l+=1==h[c-1][a+o].meta.matchType||a+1==i?1:2);n="match-"+r[1]+"-"+(c-1)+"-"+l+m}return n},findConnectingMatch:function(t){return angular.element(document.getElementById(this.findConnectingMatchId(t)))},findChildMatch:function(t){for(var e=angular.element(t).children(),a=0;a<e.length;a++)if(angular.element(e[a]).hasClass("match"))return angular.element(e[a])},findConferenceFinals:function(){function a(e,a){var n=t.getMatches(e),r=n.length,c=n[r-1].length,i="DE"!==t.getTournamentType()||a?1:c;return"match-"+e+"-"+r+"-"+i}var n=a("C1");return e.C1=angular.element(document.getElementById(n)).children()[0],t.isDoubleConference()&&(n=a("C2"),e.C2=angular.element(document.getElementById(n)).children()[0],"DE"===t.getTournamentType()&&(n=a("C2",!0),e.C2_1=angular.element(document.getElementById(n)).children()[0])),e}}}]).factory("layoutService",["data",function(t){function e(t){return"L"!==t.meta.matchId.slice(-1)}function a(t){return"L"===t.meta.matchId.slice(-1)}function n(t){var e=document.getElementsByClassName("roundHeader")[0],a=document.getElementsByClassName("round")[0];matchEl=document.createElement("div"),matchEl.style.visibility="hidden",matchEl.className="match",e&&a&&(a.appendChild(matchEl),document.all?(t.matchHeight=matchEl.currentStyle.height,t.matchWidth=matchEl.currentStyle.width,t.matchMarginH=parseInt(matchEl.currentStyle.marginRight),t.matchMarginV=parseInt(matchEl.currentStyle.marginTop)+parseInt(matchEl.currentStyle.marginBottom),t.borderThickness=parseInt(matchEl.currentStyle.borderWidth),t.roundMarginTop=e.currentStyle.height+parseInt(e.currentStyle.marginTop)+parseInt(e.currentStyle.marginBottom)):(t.matchHeight=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("height").replace("px","")),t.matchWidth=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("width").replace("px","")),t.matchMarginH=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-right").replace("px","")),t.matchMarginV=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-bottom")),t.borderThickness=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("border-right-width")),t.roundMarginTop=parseInt(document.defaultView.getComputedStyle(e,"").getPropertyValue("height").replace("px",""))+parseInt(document.defaultView.getComputedStyle(e,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(e,"").getPropertyValue("margin-bottom"))),a.removeChild(matchEl),i=!0)}function r(n){var r=t.getMatches("C1");if(!r)return n.bracket.width="0 px",void(n.bracket.height="0 px");var c,i=0,m="DE"===t.getTournamentType();m&&(c=angular.module("ngBracket").findFirstRound(r),null!==c&&(n.startingRound1=c+1,i=Math.max(r[c].filter(e).length,r[c+1].filter(e).length),i+=Math.max(r[0].filter(a).length,r[1].filter(a).length)),n.lbOffset1=t.getProperties().lbOffset1*(n.matchHeight+n.matchMarginV)+n.roundMarginTop,i+=.5);var l=r.length;if(i=0!==i?i:Math.max(r[0].length,r[1].length),t.isDoubleConference()){r=t.getMatches(),c=angular.module("ngBracket").findFirstRound(r[2].matches),l=r[0].matches.length+1+r[2].matches.length+(m?2:0);var h=Math.max(r[2].matches[c].filter(e).length,r[2].matches[c+1].filter(e).length);h+=Math.max(r[2].matches[0].filter(a).length,r[2].matches[1].filter(a).length),m&&(n.startingRound2=c+1,h+=.5,n.lbOffset2=t.getProperties().lbOffset2*(n.matchHeight+n.matchMarginV)+n.roundMarginTop),i>h?n.paddingTopC2=(i-h)/2:(n.paddingTopC1=(h-i)/2,i=h),r=r[0].matches.length>r[2].matches.length?r[0].matches:r[2].matches}n.bracket.height=String(i*(n.matchHeight+n.matchMarginV)+n.roundMarginTop)+"px",n.bracket.width=String(l*(n.matchWidth+n.matchMarginH))+"px"}var c={matchHeight:null,matchWidth:null,matchMarginH:null,matchMarginV:null,borderThickness:null,roundMarginTop:null,startingRound1:null,startingRound2:null,lbOffset1:null,lbOffset2:null,paddingTopC1:null,paddingTopC2:null,bracket:{width:null,height:null}},i=!1;return{getProperties:function(){return i||(n(c),r(c)),c},refresh:function(){r(c)}}}]),angular.module("ngBracket").factory("tournamentGenerator",function(){return{newTournament:function(t,e,a,n){function r(t,e,a){return{team1:{id:"",score:""},team2:{id:"",score:""},meta:{matchId:"match-"+a+"-"+t+"-"+e},details:{}}}function c(t,e,a){for(var n=[],r=a?2*t-e:e,c=a?t/Math.abs(2*t-e):t/e,i=0;i<t;i++)n[i]=a?2:0;for(i=0;i<r;i++){var m=Math.round(i*c);n[m]=a?n[m]-1:n[m]+1}return n}function i(t,e,a,n){function i(t,e){var a,n=0;for(a=0;a<t.length;a++)2!=t[a].meta.matchType&&(n+=1==t[a].meta.matchType?1:2);for(a=n;a<e.length;a++)e[a].meta.UIShiftDown=e[a].meta.UIShiftDown?e[a].meta.UIShiftDown+1:1}var m,l,h=[],o=1,s=null,d=0;if(1===e){for(;2*o<t.length;)o*=2;var u=t.length-o;if(u>0){d=u-o/2;var p;console.log("shiftedMatches",d),console.log("closestBalancedTree",o),p=0===d?o:d>0?o+2*d:o-2*Math.abs(d),console.log("startIndex",p),s=t.slice(p,t.length),t.splice(p,t.length)}}for(m=0;m<t.length;m++){if(l=r(e,h.length+1,n),1===e){if(m%2!==0)continue;l.team1.id=t[m].id,l.team2.id=t[m+1].id}else if(m%2!==0)continue;h.push(l)}var g;if(1===e&&null!==s&&s.length>0){a.matches.push(h.slice()),a.properties.unbalanced=!0;var f=[];if(0===d)for(m=0;m<s.length;m++)l=r(e+1,f.length+1,n),l.team1.id=s[m].id,l.meta.matchType=1,f.push(l);else if(d>0){g=c(o/2,s.length,!1);var y=0;for(m=0;m<g.length;m++)l=r(e+1,f.length+1,n),1===g[m]&&(l.team1.id=s[y].id,l.meta.matchType=1,y+=1),f.push(l)}else if(d<0){g=c(o/2,s.length,!0);var v=0;for(m=0;m<o/2;m++)l=r(e+1,f.length+1,n),l.team1.id=s[v].id,l.meta.matchType=1,2===g[m]&&(l.team2.id=s[v+1].id,l.meta.matchType=2,i(f,h),v+=1),v+=1,f.push(l)}return t=null,f}return t=null,h}function m(t,e,a,n,i){var m,l,h,o,s=[];if(!(1===e&&n.matches.length>1||n.properties.unbalanced&&2===e)){var d=e>2&&n.properties.unbalanced&&n.matches[0].length!==n.matches[1].length?1:0,u=!0;if(e>1){var p=a.length-1;for(h=0;h<a[p].length;h++)if(!a[p][h].meta.matchType){u=!1;break}}if(u&&3===e&&(n.matches[0].length<n.matches[1].length||a[0].length===a[1].length)&&(u=!1),(e+d)%2!==0||u)if(n.properties.unbalanced&&e<=2)if(t.length===n.matches[0].length)m=t.length;else{if(t.length>n.matches[0].length){for(a[0]=[],a[1]=[],h=0;h<n.matches[0].length;h++)a[0].push(r(1,h+1+"-L",i));var g=a[0].length>t.length/2;for(dist=c(t.length/2,a[0].length,g),h=0;h<t.length/2;h++)o=r(2,h+1+"-L",i),g?1===dist[h]&&(o.meta.matchType=1):o.meta.matchType=1===dist[h]?1:2,a[1].push(o);if(!g&&dist.length>a[0].length){var f=0,y=0;for(h=0;h<dist.length;h++)1!==dist[h]?f+=1:(a[0][y].meta.UIShiftDown=f,y+=1)}return}if(t.length<n.matches[0].length){a[0]=[],a[1]=[];var v=0;for(h=0;h<t.length;h++)1===t[h].meta.matchType?(o=r(2,h+1+"-L",i),o.meta.matchType=2,a[1].push(o),v+=1):(o=r(1,a[0].length+1+"-L",i),o.meta.UIShiftDown=v,a[0].push(o),o=r(2,h+1+"-L",i),o.meta.matchType=1,a[1].push(o));return}}else m=1===e?Math.floor(t.length/2):Math.floor(a[a.length-1].length/2);else m=Math.floor(a[a.length-1].length),l=!0;for(h=1;h<=m;h++)o=r(a.length+1,h+"-L",i),l&&(o.meta.matchType=1),s.push(o);if(a.push(s),1===t.length)for(;1!==a[a.length-1].length||1!==a[a.length-2].length;){e+=1;var T=[];for(m=(e+d)%2===0?Math.floor(a[a.length-1].length):Math.floor(a[a.length-1].length/2),l=(e+d)%2===0,0===m&&(m=1,l=!0),h=1;h<=m;h++)o=r(a.length+1,h+"-L",i),l&&(o.meta.matchType=1),T.push(o);a.push(T)}}}function l(t,e,a,c){var l=[],o=[],s=1,d=h();for(d.matches=[];1===s||Math.floor(l.length)>1;){var u=l;1===s&&(u=e.slice()),l=i(u,s,d,c),console.log(l),"DE"===d.type&&m(l,s,o,d,c),d.matches.push(l.slice()),s=d.matches.length+1}if("DE"===d.type){for(var p=Math.max(d.matches[0].length,d.matches[1].length)+.5,g=0;g<o[0].length;g++)o[0][g].meta.UIShiftDown=isNaN(o[0][g].meta.UIShiftDown)?p:o[0][g].meta.UIShiftDown+p,d.properties.lbOffset=p;p=o.length-d.matches.length;var f,y,v,T=0;if(d.properties.unbalanced){if(d.matches[0].length===d.matches[1].length)for(g=0;g<2;g++)for(f=d.matches[g].length,j=0;j<d.matches[g].length;j++)y="match-"+c+"-"+(g+1+p)+"-"+(j+1),d.matches[g][j].meta.matchId=y,g>0?(o[0][f-1-j].meta.team2Parent=y,d.matches[g][j].meta.loserMatchId=o[0][f-1-j].meta.matchId):(o[0][j].meta.team1Parent=y,d.matches[g][j].meta.loserMatchId=o[0][j].meta.matchId);else if(d.matches[0].length>d.matches[1].length){var b=0,I=0;for(g=0;g<2;g++)for(f=d.matches[g].length,j=0;j<f;j++)d.matches[g][j].meta.matchId="match-"+c+"-"+(g+1+p)+"-"+(j+1),g>0&&(1===d.matches[g][j].meta.matchType?(o[g][j].meta.matchType=2,o[g][j].meta.team1Parent=d.matches[0][b].meta.matchId,o[g][j].meta.team2Parent="match-"+(g+1+p)+"-"+(f-j),d.matches[0][b].meta.loserMatchId=o[g][j].meta.matchId,d.matches[g][f-j-1].meta.loserMatchId=o[g][j].meta.matchId,b+=1):(o[g][j].meta.matchType=1,o[0][I].meta.team1Parent=d.matches[0][b].meta.matchId,o[0][I].meta.team2Parent=d.matches[0][b+1].meta.matchId,o[g][j].meta.team1Parent="match-"+(g+1+p)+"-"+(f-j),d.matches[0][b].meta.loserMatchId=o[0][I].meta.matchId,d.matches[0][b+1].meta.loserMatchId=o[0][I].meta.matchId,d.matches[g][f-j-1].meta.loserMatchId=o[g][j].meta.matchId,I+=1,b+=2))}else if(d.matches[0].length<d.matches[1].length){var C=!1;for(g=0;g<2;g++)for(f=d.matches[g].length,j=0;j<f;j++)if(y="match-"+c+"-"+(g+1+p)+"-"+(j+1),d.matches[g][j].meta.matchId=y,0===g)o[g][j].meta.team1Parent=y,d.matches[g][j].meta.loserMatchId=o[g][j].meta.matchId;else if(d.matches[g][j].meta.matchType)if(C)for(v=0;v<o[1].length;v++){if(!(1!==o[1][v].meta.matchType&&2!==o[1][v].meta.matchType||o[1][v].meta.team1Parent)){o[1][v].meta.team1Parent=y,d.matches[g][j].meta.loserMatchId=o[1][v].meta.matchId;break}if(2===o[1][v].meta.matchType&&!o[1][v].meta.team2Parent){
o[1][v].meta.team2Parent=y,d.matches[g][j].meta.loserMatchId=o[1][v].meta.matchId;break}}else o[0][o[0].length-j-1].meta.team2Parent=y,d.matches[g][j].meta.loserMatchId=o[0][o[0].length-j-1].meta.matchId,C=j===o[0].length-1}T=2}for(g=T;g<d.matches.length;g++){var k=g<2?g:2*g-1,M=0;for(d.properties.unbalanced&&(k-=1,M=1),g===d.matches.length-1&&(k=o.length-1),f=d.matches[g].length,j=0;j<f;j++){var D="match-"+c+"-"+(k+1)+"-";for(D+=0===g?Math.floor(j/2)+1:(g+M)%2===0?j+1:f-j,D+="-L",y="match-"+c+"-"+(g+1+p)+"-"+(j+1),v=o[k].length-1;v>=0;v--)if(o[k][v].meta.matchId===D){o[k][v].meta.team1Parent?o[k][v].meta.team2Parent=y:o[k][v].meta.team1Parent=y;break}d.matches[g][j].meta.matchId=y,d.matches[g][j].meta.loserMatchId=D}}for(j=d.matches.length-1,g=o.length-1;g>=0;g--)j>=0?d.matches[j]=d.matches[j].concat(o[g]):d.matches.unshift(o[g]),j-=1;d.matches.push(new Array(r(d.matches.length+1,1,c)));var E=r(d.matches.length,d.matches[d.matches.length-1].length+1,c);E.meta.matchType="finals2",d.matches[d.matches.length-1].push(E)}if(d.matches[d.matches.length-1][0].meta.matchType=n?"conference-finals":"finals",a){var $=r(d.matches.length,d.matches[d.matches.length-1].length+1,c);$.meta.matchType="bronze",d.matches[d.matches.length-1].push($)}return d}function h(){return{type:t,conferences:[],properties:{status:"Not started"}}}var o=h();if(!n&&e.length<3||n&&2!==e.length)return o;if(n&&"DE"==t)return void alert("Double elimination double conference is not supported at the moment.");if(n){o.doubleConference=!0;var s=l(t,e[0],!1,"C1");if(!s)return;o.conferences.push({matches:s.matches.slice()}),o.properties.lbOffset1=s.properties.lbOffset,s={conferenceName:"Finals",matches:[[]]};var d=r("F",1,"F");if(d.meta.matchType="finals",s.matches[0].push(d),a&&(d=r("F",2,"F"),d.meta.matchType="bronze",s.matches[0].push(d)),o.conferences.push(s),s=l(t,e[1],!1,"C2"),!s)return;o.conferences.push({matches:s.matches.slice()}),o.properties.lbOffset2=s.properties.lbOffset}else{var u=l(t,e,a,"C1");o.conferences.push({matches:u.matches.slice()}),o.properties.lbOffset1=u.properties.lbOffset}return o},shuffle:function(t){if(t&&t.teams&&t.tournament&&"Not started"==t.tournament.properties.status){for(var e,a,n=t.tournament,r=t.teams.length,c=t.teams.slice();0!==r;)a=Math.floor(Math.random()*r),r-=1,e=c[r],c[r]=c[a],c[a]=e;var i,m=0,l="DE"===n.type?angular.module("ngBracket").findFirstRound(n.matches):0;for(i=0;i<n.matches[l].length&&"L"!==n.matches[l][i].meta.matchId.slice(-1);i++)n.matches[l][i].team1.id=c[m].id,n.matches[l][i].team2.id=c[m+1].id,m+=2;if(n.properties.unbalanced)for(l+=1,i=0;i<n.matches[l].length&&!(m>=c.length||"L"===n.matches[l][i].meta.matchId.slice(-1));i++)1===n.matches[l][i].meta.matchType?(n.matches[l][i].team1.id=c[m].id,m+=1):2===n.matches[l][i].meta.matchType&&(n.matches[l][i].team1.id=c[m].id,n.matches[l][i].team2.id=c[m+1].id,m+=2)}}}});